<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AlliedWork â€“ Team Roster</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/gh/pocketbase/js-sdk@master/dist/pocketbase.umd.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="min-h-screen bg-[#050505] text-white font-sans flex p-6 gap-6">

  <div id="sidebar-container" class="w-1/6 h-[calc(100vh-3rem)] sticky top-6"></div>

  <main class="flex-1 bg-zinc-900/20 border border-white/5 rounded-[3rem] p-12 overflow-y-auto backdrop-blur-sm">
    
    <div id="noTeamView" class="hidden text-center py-20">
      <h2 class="text-5xl font-black italic uppercase tracking-tighter mb-4">No Team Linked</h2>
      <p class="text-zinc-500 mb-12 max-w-md mx-auto uppercase text-[10px] tracking-[0.3em] font-bold">Access Denied: Please create or join a division.</p>
      <div class="flex flex-col sm:flex-row justify-center gap-6">
        <button onclick="createTeam()" class="px-12 py-5 bg-white text-black rounded-2xl font-bold hover:scale-105 transition shadow-xl shadow-white/5">Create Team</button>
        <button onclick="joinTeam()" class="px-12 py-5 bg-zinc-900 border border-white/10 rounded-2xl font-bold hover:bg-zinc-800 transition">Join Team</button>
      </div>
    </div>

    <div id="teamView" class="hidden">
      <div class="mb-12">
        <h2 id="teamNameHeader" class="text-7xl font-black italic uppercase tracking-tighter mb-6 leading-none">TEAM</h2>
        
        <div class="flex flex-col md:flex-row items-center gap-6 bg-zinc-900/40 border border-white/5 p-8 rounded-[2.5rem]">
            <div class="flex-1">
                <p class="text-zinc-600 text-[10px] uppercase font-black tracking-[0.4em] mb-2">Invite Token</p>
                <code id="joinCodeText" class="text-3xl font-mono text-indigo-400 tracking-widest uppercase">------</code>
            </div>
            <button onclick="copyCode()" class="w-full md:w-auto px-10 py-4 bg-white/5 border border-white/10 rounded-2xl font-bold hover:bg-white/10 transition text-xs uppercase tracking-widest">Copy Code</button>
        </div>
      </div>

      <div class="space-y-6">
        <div class="flex justify-between items-center border-b border-white/5 pb-4">
            <h3 class="text-[10px] font-black uppercase tracking-[0.4em] text-zinc-600">Active Personnel</h3>
            <span id="rosterCount" class="text-[9px] bg-indigo-500/10 text-indigo-400 px-3 py-1 rounded-full border border-indigo-500/20 font-bold uppercase tracking-widest">0 Members</span>
        </div>
        
        <div id="memberList" class="grid grid-cols-1 gap-4">
            <p class="text-zinc-700 italic text-sm py-4">Scanning for members...</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const pb = new PocketBase('https://bottom-edyth-alliedalgo-d6d346de.koyeb.app');

    // 1. RUN ON LOAD
    $(function() {
      // Use ../ to get out of /team/ and find /layout/
      $("#sidebar-container").load("../layout/sidebar.html", function(response, status, xhr) {
          if (status == "error") {
              console.error("Sidebar load failed. Check your path: ../layout/sidebar.html");
          } else {
              init(); // Only run PocketBase logic AFTER sidebar is in the DOM
          }
      });
    });

    async function init() {
      if (!pb.authStore.isValid) return window.location.replace("../auth/login.html");
      
      const user = pb.authStore.model;

      try {
        // Fetch User and Expand Team
        const userRecord = await pb.collection('users').getOne(user.id, { expand: 'team' });
        
        if (!userRecord.team) {
          $("#noTeamView").removeClass("hidden");
        } else {
          $("#teamView").removeClass("hidden");
          const team = userRecord.expand.team;
          
          // Update Page UI
          $("#teamNameHeader").text(team.name);
          $("#joinCodeText").text(team.join_code || team.id);
          
          // Update Sidebar UI (The elements jQuery just loaded)
          $("#teamLabel").text(team.name);
          $("#userName").text(user.name || user.email);
          $("#userInitials").text((user.name || user.email).substring(0,2).toUpperCase());

          // Load the Roster
          loadRoster(userRecord.team);
        }
      } catch (err) {
        console.error("Initialization Error:", err);
      }
    }

    async function loadRoster(teamId) {
      try {
        // Fetch all users on this team
        const members = await pb.collection('users').getFullList({
          filter: `team = "${teamId}"`,
          sort: '+created'
        });

        $("#rosterCount").text(`${members.length} Members`);

        const list = $("#memberList");
        list.empty(); // Clear the "Scanning..." text

        members.forEach(m => {
          const isMe = m.id === pb.authStore.model.id;
          const name = m.name || m.email.split('@')[0];
          
          list.append(`
            <div class="flex items-center justify-between p-6 bg-zinc-900/20 border border-white/5 rounded-[1.8rem] transition hover:bg-zinc-900/40 hover:border-white/10">
              <div class="flex items-center gap-5">
                <div class="w-12 h-12 rounded-full bg-zinc-800 border border-white/10 flex items-center justify-center font-bold text-xs text-zinc-500 uppercase">
                  ${name.substring(0,2)}
                </div>
                <div>
                  <p class="font-bold text-sm ${isMe ? 'text-white' : 'text-zinc-400'}">
                    ${name} ${isMe ? '<span class="ml-2 text-[8px] bg-white/10 px-2 py-0.5 rounded tracking-tighter uppercase font-black text-zinc-500">You</span>' : ''}
                  </p>
                  <p class="text-[10px] text-zinc-600 font-mono tracking-tighter">${m.email}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="text-[8px] text-zinc-700 uppercase font-black tracking-[0.2em] px-4 py-2 border border-white/5 rounded-full">Authorized</span>
              </div>
            </div>
          `);
        });

      } catch (err) {
        console.error("Roster Load Error:", err);
      }
    }

    // CREATE TEAM Logic
    window.createTeam = async () => {
      const name = prompt("Enter Division Name:");
      if (!name) return;
      try {
        const team = await pb.collection('teams').create({ name, owner: pb.authStore.model.id });
        await pb.collection('teams').update(team.id, { join_code: team.id });
        await pb.collection('users').update(pb.authStore.model.id, { team: team.id });
        location.reload();
      } catch (err) { alert("Creation Failed: " + err.message); }
    };

    // JOIN TEAM Logic
    window.joinTeam = async () => {
      const code = prompt("Enter Join Code:");
      if (!code) return;
      try {
        const team = await pb.collection('teams').getFirstListItem(`join_code="${code}"`);
        await pb.collection('users').update(pb.authStore.model.id, { team: team.id });
        location.reload();
      } catch (err) { alert("Invalid join code."); }
    };

    window.copyCode = () => {
      navigator.clipboard.writeText($("#joinCodeText").text());
      alert("Code Copied to Clipboard");
    };

    window.logout = () => {
      pb.authStore.clear();
      window.location.replace("../auth/login.html");
    };
  </script>
</body>
</html>